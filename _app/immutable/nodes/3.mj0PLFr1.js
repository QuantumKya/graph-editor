import"../chunks/CWj6FrbW.js";import{o as ce}from"../chunks/a7uudO9m.js";import{aF as tt,i as ot,O as nt,K as at,P as Q,R as k,T as H,f as j,c as T,s as x,g as e,d as f,r as R,t as q,b as U,Q as X,aj as Te,au as rt,a as it,aG as ie,aD as Pe,$ as Re}from"../chunks/CdiwDntd.js";import{l as lt,d as $,r as je,h as st,e as Ue}from"../chunks/CMfIiZwR.js";import{i as te}from"../chunks/C8ykwlrY.js";import{a as ke,s as C,t as le,b as J,e as dt,i as ct,h as ut,V as B,C as ft,c as Oe,f as vt,g as ee,d as re}from"../chunks/KhoVA3ES.js";import{b as z}from"../chunks/BLMSFg2n.js";import{r as Ge,s as se}from"../chunks/59QRH0I1.js";import{b as ze}from"../chunks/2dnsDG_s.js";function de(i,d,g=d){var r=tt();lt(i,"input",a=>{var c=a?i.defaultValue:i.value;if(c=we(i)?xe(c):c,g(c),r&&c!==(c=d())){var w=i.selectionStart,b=i.selectionEnd;i.value=c??"",b!==null&&(i.selectionStart=w,i.selectionEnd=Math.min(b,i.value.length))}}),(ot&&i.defaultValue!==i.value||nt(d)==null&&i.value)&&g(we(i)?xe(i.value):i.value),at(()=>{var a=d();we(i)&&a===xe(i.value)||i.type==="date"&&!a&&!i.value||a!==i.value&&(i.value=a??"")})}function we(i){var d=i.type;return d==="number"||d==="range"}function xe(i){return i===""?null:+i}var gt=j('<img alt="Uploaded Icon" class="rounded-lg w-[100px]"/>'),mt=j('<img alt="Uploaded Icon" class="rounded-lg w-[100px]"/>'),pt=j('<div class="flex flex-col gap-3.5 max-w-[350px] h-fit bg-neutral-950 text-white p-2.5 rounded-xl"><input type="text" placeholder="Node Title"/> <textarea rows="5" placeholder="Node Description"></textarea> <div class="flex flex-row gap-2"><!> <div class="flex flex-col gap-5"><button>Upload Image</button> <input type="file" accept="image/*"/> <div class="relative inline-block h-fit"><button>Save</button> <button>Exit</button></div></div></div></div>');function ht(i,d){Q(d,!0);let g=k(H(d.node.name)),r=k(H(d.node.description)),a=k(H(d.node.image)),c,w,b,E=!1,O=!1;ce(()=>{w.value=d.node.name,b.value=d.node.description});const N=()=>{E=!0};var y=pt(),m=T(y);Ge(m),m.__change=N,z(m,h=>w=h,()=>w);var _=x(m,2);je(_),_.__change=N,z(_,h=>b=h,()=>b);var o=x(_,2),p=T(o);{var S=h=>{var D=gt();q(()=>se(D,"src",e(a))),U(h,D)},I=h=>{var D=mt();q(()=>se(D,"src",ze+"/landscape-placeholder.svg")),U(h,D)};te(p,h=>{e(a)!==""?h(S):h(I,!1)})}var v=x(p,2),L=T(v);L.__click=h=>{c.click()};var A=x(L,2);A.__change=h=>{const D=h.target;if(!D.files||D.files.length===0)return;const P=D.files[0],K=new FileReader;K.onload=()=>{typeof K.result=="string"?f(a,K.result,!0):f(a,"")},K.readAsDataURL(P),N()},ke(A,"",{},{display:"none"}),z(A,h=>c=h,()=>c);var Y=x(A,2),M=T(Y);M.__click=()=>{O=d.saveNode(d.node,e(g),e(r),e(a))};var W=x(M,2);W.__click=()=>d.exitNode(O,E),R(Y),R(v),R(o),R(y),q(()=>{C(m,1,le),C(_,1,`${le} placeholder:text-neutral-400 resize-none overflow-scroll`),C(L,1,`${J} h-fit`),C(M,1,`${J} float-left`),C(W,1,`${J} float-right`)}),de(m,()=>e(g),h=>f(g,h)),de(_,()=>e(r),h=>f(r,h)),U(i,y),X()}$(["change","click"]);var bt=j('<div class="w-[5px] bg-neutral-300 rounded-full m-3"></div>'),_t=j("<button><img/></button>"),wt=j('<div class="flex absolute rounded-xl bg-neutral-200 border-blue-300 border-2 p-[10px] pt-[5px] pb-[5px] h-fit bottom-6 left-[50%] transform -translate-[50%]"></div>');function xt(i,d){Q(d,!0);let g=k(2),r=["node_add.png","node_edit.png","node_drag.png","","link_add.png","link_edit.png"];Te(()=>{d.modeChanged(e(g))});var a=wt();dt(a,21,()=>r,ct,(c,w,b)=>{var E=rt(),O=it(E);{var N=m=>{var _=bt();U(m,_)},y=m=>{var _=_t();_.__click=()=>f(g,b-r.slice(0,b).filter(p=>p==="").length);var o=T(_);R(_),q((p,S,I)=>{C(_,1,`p-2.5 rounded-xl border-none outline-none transition duration-200 hover:bg-blue-300 ${p??""}`),se(o,"src",`${ze??""}/mode_icons/${e(w)??""}`),se(o,"alt",S),C(o,1,I)},[()=>e(g)===b-r.slice(0,b).filter(p=>p==="").length?"bg-gray-500 mt-auto mb-auto":"mt-[10px] mb-[10px]",()=>r[b].split(".")[0],()=>ut(e(g)===b-r.slice(0,b).filter(p=>p==="").length?"max-w-[40px] rounded-xl":"max-w-[30px] rounded-lg")]),U(m,_)};te(O,m=>{e(w)===""?m(N):m(y,!1)})}U(c,E)}),R(a),U(i,a),X()}$(["click"]);var kt=j('<button aria-label="Close Menu"><i class="fa-solid fa-chevron-down"></i></button>'),yt=j('<button aria-label="Open Menu"><i class="fa-solid fa-chevron-up"></i></button>'),St=j(`<div class="absolute bottom-1 left-1 transition duration-200"><!> <div class="flex flex-col gap-0 w-fit p-1 rounded-xl font-mono text-blue-300 bg-gray-800 border-2 border-blue-500"><p class="text-center">------------------ Edit Log ------------------</p> <textarea class="resize-none overflow-y-scroll text-wrap outline-none" readonly="" cols="48" rows="8">
        </textarea></div></div>`);function Lt(i,d){Q(d,!0);let g=H([]),r,a=k(0),c=H([]),w=k(!0),b,E;const O=(v,L)=>{e(a)>0&&(g.splice(-e(a),e(a)),f(a,0)),c.push(v),g.push(L===void 0?v:v+`:
	`+L)},N=()=>{e(a)>c.length-1||(ie(a),g.push("Undo: "+c.at(-e(a))))},y=()=>{e(a)<1||(g.push("Redo: "+c.at(-e(a))),ie(a,-1))};Te(()=>{r.value+=`
`+g.at(-1),r.scrollTop=r.scrollHeight}),ce(()=>{r.value=""});var m=St(),_=T(m);{var o=v=>{var L=kt();L.__click=A=>{f(w,!1),b.style.bottom=`-${E.offsetHeight}px`},U(v,L)},p=v=>{var L=yt();L.__click=A=>{f(w,!0),b.style.bottom="4px"},U(v,L)};te(_,v=>{e(w)?v(o):v(p,!1)})}var S=x(_,2),I=x(T(S),2);return z(I,v=>r=v,()=>r),R(S),z(S,v=>E=v,()=>E),R(m),z(m,v=>b=v,()=>b),U(i,m),X({log:O,undo:N,redo:y})}$(["click"]);var Dt=j('<div class="flex flex-col gap-3.5 max-w-[350px] h-fit bg-neutral-950 text-white p-2.5 rounded-xl"><input type="text" placeholder="Link Title"/> <textarea rows="5" placeholder="Link Description"></textarea> <div class="relative inline-block h-fit"><button>Save</button> <button>Exit</button></div></div>');function Et(i,d){Q(d,!0);let g=k(""),r=k(""),a,c,w=!1,b=!1;ce(()=>{a.value=d.link.name,c.value=d.link.description});const E=()=>{b=!0};var O=Dt(),N=T(O);Ge(N),N.__change=E,z(N,p=>a=p,()=>a);var y=x(N,2);je(y),y.__change=E,z(y,p=>c=p,()=>c);var m=x(y,2),_=T(m);_.__click=()=>{w=d.saveLink(d.link,e(g),e(r))};var o=x(_,2);o.__click=()=>d.exitLink(w,b),R(m),R(O),q(()=>{C(N,1,le),C(y,1,`${le} placeholder:text-neutral-400 resize-none overflow-scroll`),C(_,1,`${J} float-left`),C(o,1,`${J} float-right`)}),de(N,()=>e(g),p=>f(g,p)),de(y,()=>e(r),p=>f(r,p)),U(i,O),X()}$(["change","click"]);var Nt=j('<div class="flex flex-row gap-3 w-min h-min p-3 absolute top-1 left-1 text-2xl pointer-events-none"><button aria-label="Undo"><i class="fas fa-undo"></i></button> <button aria-label="Redo"><i class="fas fa-redo"></i></button></div>');function It(i,d){Q(d,!0);var g=Nt(),r=T(g);r.__click=function(...c){var w;(w=d.undo)==null||w.apply(this,c)};var a=x(r,2);a.__click=function(...c){var w;(w=d.redo)==null||w.apply(this,c)},R(g),q(()=>{C(r,1,`border-none rounded-full w-fit h-fit p-2 pt-0.5 pb-1 text-center ${d.undoable?"bg-gray-300":"bg-gray-400"} pointer-events-auto`),C(a,1,`border-none rounded-full w-fit h-fit p-2 pt-0.5 pb-1 text-center ${d.redoable?"bg-gray-300":"bg-gray-400"} pointer-events-auto`)}),U(i,g),X()}$(["click"]);var At=j(`<style>body {
            overflow-y: hidden;
        }</style>`),Ct=i=>i.preventDefault(),Mt=j('<div id="canvas-box" class="relative inline-block overflow-hidden"><canvas tabindex="0"></canvas> <div class="absolute z-10"><!></div> <div class="absolute right-2.5 bottom-2.5"><button aria-label="Save Image">Save Image</button> <button aria-label="Save Graph">Save Graph</button> <button aria-label="Load Graph">Load Graph</button> <input type="file" accept=".json"/></div> <!> <!> <!> <!></div>');function Wt(i,d){Q(d,!0);const g=()=>{const t=e(p).at(-e(S))??e(o);if(f(o,re(t),!0),I.length!==e(o).nodes.length){for(;I.length<e(o).nodes.length;)I.push(new Image);for(;I.length>e(o).nodes.length;)I.pop()}e(o).nodes.forEach((l,s)=>{I[s].src=l.image});const n=e(o).nodes.findIndex(l=>l.id===e(v));f(v,n,!0)};let r,a=new B(0,0),c=1;const w=.5,b=2;let E=k(!1),O,N,y,m=k(H(new B(0,0))),_=new B(0,0),o=k(H({nodes:[{id:0,name:"Node",description:"",image:"",position:[200,300]}],links:[]})),p=k(H([{nodes:[{id:0,name:"Node",description:"",image:"",position:[200,300]}],links:[]}])),S=k(1),I=[],v=k(-1),L=k(!1),A=k(!1),Y=k(-1),M=k(!1),W,h=k(!1),D=k(0),P;const K=()=>{const t=r.getContext("2d");if(t===null)throw new Error("DRAW LOOP - ctx is null");r.width=window.innerWidth,r.height=window.innerHeight,t.clearRect(0,0,r.width,r.height),t.setTransform(c,0,0,c,-a.x,-a.y),e(h)&&(t.beginPath(),t.moveTo(e(o).nodes[e(v)].position[0],e(o).nodes[e(v)].position[1]),t.lineTo(y.x,y.y),t.lineWidth=10,t.strokeStyle="rgba(0, 0, 0, 0.35)",t.stroke()),e(o).links.forEach(n=>{t.beginPath();const l=e(o).nodes.find(u=>u.id===n.from)??e(o).nodes[0],s=e(o).nodes.find(u=>u.id===n.to)??e(o).nodes[0];t.moveTo(l.position[0],l.position[1]),t.lineTo(s.position[0],s.position[1]),t.lineWidth=10,t.strokeStyle="black",t.stroke()}),e(o).nodes.forEach((n,l)=>{const s=B.fromArray(n.position),u=25;t.beginPath(),t.arc(s.x,s.y,20,0,Math.PI*2),t.fillStyle="black",t.fill(),t.drawImage(I[l],s.x-u/2,s.y-u/2,u,u)}),requestAnimationFrame(K)},Fe=t=>{if(e(A)||e(M))return;const n=Oe(t,r,a,c);let l=e(o).nodes.find(u=>B.fromArray(u.position).distanceSq(n)<400);l&&f(v,l.id,!0);let s=e(o).links.find(u=>{const F=e(o).nodes[u.from],G=e(o).nodes[u.to];return vt(B.fromArray(F.position),B.fromArray(G.position),n)<10});if(s&&f(Y,e(o).links.indexOf(s),!0),t.button===0){if(e(D)===0){if(!l)e(o).nodes.push({id:-1,name:"",description:"",image:"",position:n.toArray()}),ve(),I.push(new Image),Z(),P.log("Create node");else if(window.confirm("Delete node and its links?")){const u=l.id;e(o).nodes.splice(u,1),f(v,0),I.splice(u,1);let F=[];e(o).links.forEach((G,ae)=>{(G.from===u||G.to===u)&&F.push(ae)});for(const G of F)e(o).links.splice(G,1);ve(),Z(),P.log("Delete node",`Node ID: ${u}, ${F.length} links destroyed`)}}else if(e(D)===1){if(!l)return;f(A,!0),f(m,ee(t,r),!0)}else if(e(D)===2){if(!l)return;_=n.clone().subtract(B.fromArray(e(o).nodes[e(v)].position)),f(L,!0)}else if(e(D)===3)if(l)if(e(h)){if(W.id===e(v)||e(o).links.filter(u=>u.from===W.id&&u.to===e(v)||u.from===e(v)&&u.to===W.id).length!==0)return;e(o).links.push({from:W.id,to:e(v),name:"",description:""}),f(h,!1),Z(),P.log("Create link",`node ${W.id} -> ${e(v)}`)}else W=l,f(h,!0),y=n;else{if(!s)return;e(o).links.splice(e(Y),1),Z(),P.log("Delete link",`node ${W.id} -> ${e(v)}`)}else if(e(D)===4){if(!s)return;f(M,!0),f(m,ee(t,r),!0)}}t.button===2&&(f(E,!0),O=ee(t,r),N=a.clone())},We=t=>{if(e(A)||e(M))return;const n=Oe(t,r,a,c);if(y=n,e(L)){let l=e(o).nodes.find(s=>s.id===e(v));if(!l)throw new Error("uhhh focusNode error, it's not in the list...");l.position=n.clone().subtract(_).toArray()}else if(e(E)){const s=ee(t,r).clone().subtract(O);a=N.clone().subtract(s)}},Ve=t=>{e(A)||e(M)||(e(L)&&(f(L,!1),Z(),P.log("Set node position")),f(E,!1))},Be=t=>{t.preventDefault();const n=ee(t,r),l=n.clone().add(a).divideScalar(c),s=Math.sign(t.deltaY);c-=s*.125,c=Math.max(w,Math.min(b,c)),a=l.clone().multiplyScalar(c).subtract(n)},He=t=>{t.key==="Escape"&&e(h)&&f(h,!1),t.ctrlKey&&(t.key==="o"&&(t.preventDefault(),oe.click()),t.key==="s"&&(t.preventDefault(),Le()),t.key==="z"&&ye(),t.key==="y"&&Se(),t.shiftKey&&t.key==="s"&&(t.preventDefault(),De()))},Je=(t,n,l,s)=>{let u=[t.name===n?"":"name",t.description===l?"":"description",t.image===s?"":"image"],F=[];u.forEach(Me=>{Me!==""&&F.push(Me)});const G=F.join(", ");if(G===""||!window.confirm("Save this node with new contents?"))return!1;t.name=n,t.description=l,t.image=s;const ae=e(o).nodes.indexOf(t);return ae!==-1&&(I[ae].src=t.image),Z(),P.log("Update node contents",G),!0},Ke=(t,n)=>{!t&&n&&!window.confirm("Stop editing without saving?")||f(A,!1)},Ze=(t,n,l)=>{let s=[t.name===n?"":"name",t.description===l?"":"description"],u=[];s.forEach(G=>{G!==""&&u.push(G)});const F=u.join(", ");return F===""||!window.confirm("Save this link with new contents?")?!1:(t.name=n,t.description=l,Z(),P.log("Update node contents",F),!0)},qe=(t,n)=>{!t&&n&&!window.confirm("Stop editing without saving?")||f(M,!1)},Z=()=>{e(S)>1&&(e(p).splice(-e(S)+1,e(S)-1),f(S,1)),e(p).push(re(e(o)))};let ue=Pe(()=>e(S)<e(p).length),fe=Pe(()=>e(S)>1);const ye=()=>{e(A)||e(M)||e(ue)&&(ie(S),g(),P.undo())},Se=()=>{e(A)||e(M)||e(fe)&&(ie(S,-1),g(),P.redo())},Ye=t=>{if(e(A)||e(M))return;const n=t.target;if(!n.files||n.files.length===0)return;const l=n.files[0],s=new FileReader;s.onload=()=>{if(typeof s.result=="string")try{const u=JSON.parse(s.result);if(!u.nodes||!u.links)throw new Error("Invalid graph data");f(o,re(u),!0),ve(),f(S,1),f(p,[re(e(o))],!0),g(),P.log("Load new graph data")}catch(u){alert("Failed to load graph: "+u.message)}},s.readAsText(l)},Le=()=>{if(window.confirm("Download new JSON?")){const t=JSON.stringify(e(o),null,4),n=new Blob([t],{type:"application/json"}),l=URL.createObjectURL(n),s=document.createElement("a");s.href=l,s.download="graph.json",s.click(),URL.revokeObjectURL(l)}},De=()=>{if(window.confirm("Download image? It will look as your canvas does now.")){const t=document.createElement("a");t.href=r.toDataURL("image/png"),t.download="graph.png",t.click()}};let oe,Ee;const ve=()=>{if(e(A)||e(M))return;const t=new Map(e(o).nodes.map((n,l)=>[n.id,l]));e(o).nodes.forEach((n,l)=>n.id=l),e(o).links.forEach(n=>{n.from=t.get(n.from)??n.from,n.to=t.get(n.to)??n.to})};ce(()=>{const t=new Image;t.src="",I=[t],K()});var ge=Mt();st(t=>{var n=At();Re.title="Graph Editor",U(t,n)}),Ue("keydown",Re,He);var V=T(ge);let Ne;V.__mousemove=We,V.__mousedown=Fe,V.__mouseup=Ve,V.__contextmenu=[Ct],z(V,t=>r=t,()=>r);var ne=x(V,2),Qe=T(ne);{var Xe=t=>{ht(t,{get node(){return e(o).nodes[e(v)]},saveNode:Je,exitNode:Ke})},$e=(t,n)=>{{var l=s=>{Et(s,{get link(){return e(o).links[e(Y)]},saveLink:Ze,exitLink:qe})};te(t,s=>{e(M)&&s(l)},n)}};te(Qe,t=>{e(A)?t(Xe):t($e,!1)})}R(ne);var me=x(ne,2),pe=T(me);pe.__click=De;var he=x(pe,2);he.__click=Le;var be=x(he,2);be.__click=t=>oe.click();var _e=x(be,2);_e.__change=Ye,ke(_e,"",{},{display:"none"}),z(_e,t=>oe=t,()=>oe),R(me);var Ie=x(me,2);z(Lt(Ie,{}),t=>P=t,()=>P);var Ae=x(Ie,2);It(Ae,{undo:ye,redo:Se,get undoable(){return e(ue)},set undoable(t){f(ue,t)},get redoable(){return e(fe)},set redoable(t){f(fe,t)}});var Ce=x(Ae,2);z(xt(Ce,{modeChanged:t=>f(D,t,!0)}),t=>Ee=t,()=>Ee);var et=x(Ce,2);ft(et,{controls:{"Right Click and Drag":"move viewport","Scroll Wheel":"zoom in and out","Ctrl-Z":"undo","Ctrl-Y":"redo","Ctrl-O":"open graph","Ctrl-S":"save graph","Ctrl-Shift-S":"save graph as image"},get mode(){return e(D)},set mode(t){f(D,t,!0)}}),R(ge),q(t=>{Ne=C(V,1,"bg-neutral-100",null,Ne,t),ke(ne,`left: ${e(m).x??""}px; top: ${e(m).y??""}px;`),C(pe,1,J),C(he,1,J),C(be,1,J)},[()=>({"cursor-grabbing":e(L)||e(E)})]),Ue("wheel",V,Be),U(i,ge),X()}$(["mousemove","mousedown","mouseup","contextmenu","click","change"]);export{Wt as component};
